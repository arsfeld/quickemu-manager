<!DOCTYPE html>
<html>
<head>
    <title>SPICE Console</title>
    <meta charset="utf-8">
    <style>
        body, html {
            margin: 0;
            padding: 0;
            background: #000;
            overflow: hidden;
            width: 100%;
            height: 100vh;
        }
        #spice-container {
            width: 100%;
            height: 100vh;
            position: relative;
        }
        .spice-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-family: Arial, sans-serif;
            font-size: 16px;
            z-index: 1000;
        }
        .spice-loading.hidden {
            display: none;
        }
    </style>
    <!-- Essential SPICE Web Client Libraries -->
    <script src="lib/modernizr.js"></script>
    <script src="lib/jquery-2.0.3.js"></script>
    <script src="lib/jquery-mousewheel.js"></script>
    <script src="lib/jgestures.min.js"></script>
    <script src="lib/pixastic.js"></script>
    <script src="lib/base64.js"></script>
    <script src="lib/biginteger.js"></script>
    <script src="lib/virtualjoystick.js"></script>
    
    <!-- Cryptographic libraries -->
    <script src="lib/jsbn.js"></script>
    <script src="lib/jsbn2.js"></script>
    <script src="lib/prng4.js"></script>
    <script src="lib/rng.js"></script>
    <script src="lib/sha1.js"></script>
    <script src="lib/encrypt.js"></script>

    <!-- Core SPICE libraries -->
    <script src="lib/utils.js"></script>
    <script src="lib/queue.js"></script>
    <script src="lib/runqueue.js"></script>
    <script src="lib/graphic.js"></script>
    <script src="lib/rasterEngine.js"></script>
    <script src="lib/displayRouter.js"></script>
    
    <!-- Image processing -->
    <script src="lib/images/png.js"></script>
    <script src="lib/images/lz.js"></script>
    <script src="lib/images/jsquic_family.js"></script>
    <script src="lib/images/jsquic_rgba.js"></script>
    <script src="lib/images/jsquic_uncompress.js"></script>
    <script src="lib/images/bitmap.js"></script>

    <!-- Worker support -->
    <script src="lib/AsyncConsumer.js"></script>
    <script src="lib/AsyncWorker.js"></script>
    <script src="lib/SyncAsyncHandler.js"></script>
    <script src="lib/GenericObjectPool.js"></script>
    <script src="lib/GlobalPool.js"></script>
    <script src="lib/ImageUncompressor.js"></script>

    <!-- Network layer -->
    <script src="network/socket.js"></script>
    <script src="network/websocketwrapper.js"></script>
    <script src="network/spicechannel.js"></script>
    <script src="network/packetcontroller.js"></script>
    <script src="network/packetextractor.js"></script>
    <script src="network/packetreassembler.js"></script>
    <script src="network/reassemblerfactory.js"></script>
    <script src="network/packetlinkfactory.js"></script>
    <script src="network/socketqueue.js"></script>
    <script src="network/sizedefiner.js"></script>
    <script src="network/connectioncontrol.js"></script>
    <script src="network/busconnection.js"></script>
    <script src="network/clusternodechooser.js"></script>

    <!-- SPICE objects and protocol -->
    <script src="spiceobjects/spiceobjects.js"></script>
    <script src="spiceobjects/generated/protocol.js"></script>

    <!-- Process layer -->
    <script src="process/mainprocess.js"></script>
    <script src="process/busprocess.js"></script>
    <script src="process/displayprocess.js"></script>
    <script src="process/displaypreprocess.js"></script>
    <script src="process/inputprocess.js"></script>
    <script src="process/cursorprocess.js"></script>
    <script src="process/playbackprocess.js"></script>

    <!-- Application layer -->
    <script src="application/application.js"></script>
    <script src="application/spiceconnection.js"></script>
    <script src="application/clientgui.js"></script>
    <script src="application/inputmanager.js"></script>
    <script src="application/agent.js"></script>
    <script src="application/imagecache.js"></script>
    <script src="application/stream.js"></script>
    <script src="application/packetfilter.js"></script>
    <script src="application/packetfactory.js"></script>
    <script src="application/packetprocess.js"></script>
    <script src="application/rasteroperation.js"></script>
    <script src="application/virtualmouse.js"></script>
    <script src="application/WorkerProcess.js"></script>

    <!-- Keymaps -->
    <script src="keymaps/keymap.js"></script>
    <script src="keymaps/keymapes.js"></script>
    <script src="keymaps/keymapit.js"></script>
    <script src="keymaps/keymapus.js"></script>

    <!-- Utilities -->
    <script src="lib/stuckkeyshandler.js"></script>
    <script src="lib/timelapsedetector.js"></script>
    <script src="lib/CollisionDetector.js"></script>
    <script src="lib/flipper.js"></script>
</head>
<body>
    <div id="spice-container">
        <div class="spice-loading" id="loading">
            Connecting to console...
        </div>
    </div>

    <script>
        // Configure SPICE client
        wdi.Debug.debug = false;
        wdi.exceptionHandling = false;

        var spiceApp = null;

        function getURLParameter(name) {
            return decodeURIComponent(
                (new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)')
                    .exec(location.search) || [, ""])[1]
                    .replace(/\+/g, '%20')
            ) || null;
        }

        function initSpiceConnection() {
            var host = getURLParameter('host') || 'localhost';
            var port = parseInt(getURLParameter('port')) || 6080;
            var token = getURLParameter('token') || '';
            
            console.log('Initializing SPICE connection:', { host, port, token });

            spiceApp = new Application();

            var callback = function(action, params) {
                console.log('SPICE callback:', action, params);
                
                if (action === 'ready') {
                    document.getElementById('loading').classList.add('hidden');
                    
                    // Set resolution to match viewport
                    var width = window.innerWidth;
                    var height = window.innerHeight;
                    
                    spiceApp.sendCommand('setResolution', {
                        width: width,
                        height: height
                    });
                    
                    // Notify parent window that console is ready
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'spice-console-ready',
                            width: width,
                            height: height
                        }, '*');
                    }
                } else if (action === 'init' || action === 'windowCreated') {
                    // Handle canvas creation
                    var body = $('body');
                    for (var i in params) {
                        var item = params[i];
                        var canvas = $(item.canvas).css({
                            'position': 'absolute',
                            'top': item.info.top + 'px',
                            'left': item.info.left + 'px',
                            'zIndex': 1000
                        });
                        var eventLayer = $(item.eventLayer).css({
                            'position': 'absolute',
                            'top': item.info.top + 'px', 
                            'left': item.info.left + 'px',
                            'zIndex': 1001
                        });
                        body.append(canvas);
                        body.append(eventLayer);
                    }
                } else if (action === 'windowClosed') {
                    $(params.canvas).remove();
                    $(params.eventLayer).remove();
                } else if (action === 'error') {
                    console.error('SPICE connection error:', params);
                    document.getElementById('loading').textContent = 'Connection failed: ' + params.message;
                    
                    // Notify parent window of error
                    if (window.parent !== window) {
                        window.parent.postMessage({
                            type: 'spice-console-error',
                            error: params.message || 'Unknown error'
                        }, '*');
                    }
                }
            };

            try {
                spiceApp.run({
                    callback: callback,
                    context: this,
                    host: host,
                    port: port,
                    protocol: 'ws',
                    token: token,
                    layout: 'us',
                    clientOffset: {
                        x: 0,
                        y: 0
                    }
                });
            } catch (error) {
                console.error('Failed to start SPICE app:', error);
                document.getElementById('loading').textContent = 'Failed to initialize console';
                
                if (window.parent !== window) {
                    window.parent.postMessage({
                        type: 'spice-console-error',
                        error: error.message || 'Initialization failed'
                    }, '*');
                }
            }
        }

        // Handle window resize
        window.addEventListener('resize', function() {
            if (spiceApp) {
                spiceApp.sendCommand('setResolution', {
                    width: window.innerWidth,
                    height: window.innerHeight
                });
            }
        });

        // Handle messages from parent window
        window.addEventListener('message', function(event) {
            if (event.data.type === 'send-keys') {
                // Handle special key combinations
                if (spiceApp && event.data.keys) {
                    spiceApp.sendCommand('sendKeys', { keys: event.data.keys });
                }
            }
        });

        // Initialize when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing SPICE connection...');
            initSpiceConnection();
        });
    </script>
</body>
</html>