FROM rust:1.75-slim as builder

# Install WASM target and wasmtime for lightweight WASM execution
RUN rustup target add wasm32-wasi && \
    curl https://wasmtime.dev/install.sh -sSf | bash && \
    mv /root/.wasmtime/bin/wasmtime /usr/local/bin/

# Install build dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy source files
COPY Cargo.toml Cargo.lock ./
COPY src ./src
COPY tests ./tests

# Build WASM for WASI target (supports networking)
RUN cargo build --target wasm32-wasi --features wasm-core --release

# Final stage
FROM debian:bookworm-slim

# Install wasmtime runtime
RUN apt-get update && apt-get install -y \
    curl \
    && curl https://wasmtime.dev/install.sh -sSf | bash \
    && mv /root/.wasmtime/bin/wasmtime /usr/local/bin \
    && apt-get remove -y curl \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /app

# Copy WASM binary and test scripts
COPY --from=builder /app/target/wasm32-wasi/release/*.wasm ./
COPY tests/wasm-core ./tests/

# Default command runs core protocol tests
CMD ["wasmtime", "run", "--wasi", "nn", "--wasi", "sockets", "spice_client_core.wasm"]