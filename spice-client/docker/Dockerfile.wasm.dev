# Development Dockerfile for WASM spice-client with hot-reload
FROM rust:latest

# Install dependencies
RUN apt-get update && apt-get install -y \
    pkg-config \
    libssl-dev \
    curl \
    git \
    python3 \
    python3-pip \
    && rm -rf /var/lib/apt/lists/*

# Install wasm-pack
RUN curl https://rustwasm.github.io/wasm-pack/installer/init.sh -sSf | sh

# Install wasm32 target
RUN rustup target add wasm32-unknown-unknown

# Install cargo-watch for hot-reload
RUN cargo install cargo-watch

# Install a simple HTTP server with hot-reload capability
RUN pip3 install --break-system-packages watchdog

# Create app directory
WORKDIR /app/spice-client

# Copy watch scripts
COPY spice-client/docker/scripts/watch-and-serve.sh /usr/local/bin/watch-and-serve.sh
COPY spice-client/docker/scripts/hot-reload-server.py /usr/local/bin/hot-reload-server.py
RUN chmod +x /usr/local/bin/watch-and-serve.sh /usr/local/bin/hot-reload-server.py

# Expose port for development server
EXPOSE 8080

# Run the watch script
CMD ["/usr/local/bin/watch-and-serve.sh"]